local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local main = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local up = Instance.new("TextButton")
local down = Instance.new("TextButton")
local onof = Instance.new("TextButton")
local TextLabel = Instance.new("TextLabel")
local plus = Instance.new("TextButton")
local speed = Instance.new("TextLabel")
local mine = Instance.new("TextButton")
local closebutton = Instance.new("TextButton")
local mini = Instance.new("TextButton")
local mini2 = Instance.new("TextButton")

-- Настройки
local speeds = 1
local isFlying = false
local isGUIVisible = true
local tpwalking = false

-- Создание GUI
main.Name = "FlyGuiV3"
main.Parent = player:WaitForChild("PlayerGui")
main.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
main.ResetOnSpawn = false

Frame.Parent = main
Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
Frame.BorderColor3 = Color3.fromRGB(103, 221, 213)
Frame.Position = UDim2.new(0.1, 0, 0.38, 0)
Frame.Size = UDim2.new(0, 190, 0, 57)
Frame.Active = true
Frame.Draggable = true

up.Name = "up"
up.Parent = Frame
up.BackgroundColor3 = Color3.fromRGB(79, 255, 152)
up.Size = UDim2.new(0, 44, 0, 28)
up.Font = Enum.Font.SourceSans
up.Text = "UP"
up.TextColor3 = Color3.fromRGB(0, 0, 0)
up.TextSize = 14.000

down.Name = "down"
down.Parent = Frame
down.BackgroundColor3 = Color3.fromRGB(215, 255, 121)
down.Position = UDim2.new(0, 0, 0.491, 0)
down.Size = UDim2.new(0, 44, 0, 28)
down.Font = Enum.Font.SourceSans
down.Text = "DOWN"
down.TextColor3 = Color3.fromRGB(0, 0, 0)
down.TextSize = 14.000

onof.Name = "onof"
onof.Parent = Frame
onof.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
onof.Position = UDim2.new(0.703, 0, 0.491, 0)
onof.Size = UDim2.new(0, 56, 0, 28)
onof.Font = Enum.Font.SourceSans
onof.Text = "FLY"
onof.TextColor3 = Color3.fromRGB(0, 0, 0)
onof.TextSize = 14.000

TextLabel.Parent = Frame
TextLabel.BackgroundColor3 = Color3.fromRGB(242, 60, 255)
TextLabel.Position = UDim2.new(0.469, 0, 0, 0)
TextLabel.Size = UDim2.new(0, 100, 0, 28)
TextLabel.Font = Enum.Font.SourceSans
TextLabel.Text = "FLY GUI V3"
TextLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
TextLabel.TextScaled = true
TextLabel.TextSize = 14.000
TextLabel.TextWrapped = true

plus.Name = "plus"
plus.Parent = Frame
plus.BackgroundColor3 = Color3.fromRGB(133, 145, 255)
plus.Position = UDim2.new(0.232, 0, 0, 0)
plus.Size = UDim2.new(0, 45, 0, 28)
plus.Font = Enum.Font.SourceSans
plus.Text = "+"
plus.TextColor3 = Color3.fromRGB(0, 0, 0)
plus.TextScaled = true
plus.TextSize = 14.000
plus.TextWrapped = true

speed.Name = "speed"
speed.Parent = Frame
speed.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
speed.Position = UDim2.new(0.468, 0, 0.491, 0)
speed.Size = UDim2.new(0, 44, 0, 28)
speed.Font = Enum.Font.SourceSans
speed.Text = "1"
speed.TextColor3 = Color3.fromRGB(0, 0, 0)
speed.TextScaled = true
speed.TextSize = 14.000
speed.TextWrapped = true

mine.Name = "mine"
mine.Parent = Frame
mine.BackgroundColor3 = Color3.fromRGB(123, 255, 247)
mine.Position = UDim2.new(0.232, 0, 0.491, 0)
mine.Size = UDim2.new(0, 45, 0, 29)
mine.Font = Enum.Font.SourceSans
mine.Text = "-"
mine.TextColor3 = Color3.fromRGB(0, 0, 0)
mine.TextScaled = true
mine.TextSize = 14.000
mine.TextWrapped = true

closebutton.Name = "Close"
closebutton.Parent = Frame
closebutton.BackgroundColor3 = Color3.fromRGB(225, 25, 0)
closebutton.Font = "SourceSans"
closebutton.Size = UDim2.new(0, 45, 0, 28)
closebutton.Text = "X"
closebutton.TextSize = 30
closebutton.Position = UDim2.new(0, 0, -1, 27)

mini.Name = "minimize"
mini.Parent = Frame
mini.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
mini.Font = "SourceSans"
mini.Size = UDim2.new(0, 45, 0, 28)
mini.Text = "-"
mini.TextSize = 40
mini.Position = UDim2.new(0, 44, -1, 27)

mini2.Name = "minimize2"
mini2.Parent = Frame
mini2.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
mini2.Font = "SourceSans"
mini2.Size = UDim2.new(0, 45, 0, 28)
mini2.Text = "+"
mini2.TextSize = 40
mini2.Position = UDim2.new(0, 44, -1, 57)
mini2.Visible = false

-- Уведомление
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "FLY GUI V3",
    Text = "BY XNEO | Insert - показать/скрыть GUI",
    Icon = "rbxthumb://type=Asset&id=5107182114&w=150&h=150",
    Duration = 5
})

-- Функции полета
local function enableFlight()
    if isFlying then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildWhichIsA("Humanoid")
    if not humanoid then return end
    
    isFlying = true
    onof.Text = "STOP FLY"
    onof.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
    
    -- Отключаем анимации
    character.Animate.Disabled = true
    
    -- Включаем телепортационное движение
    tpwalking = true
    for i = 1, speeds do
        spawn(function()
            local chr = player.Character
            local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
            while tpwalking and RunService.Heartbeat:Wait() and chr and hum and hum.Parent do
                if hum.MoveDirection.Magnitude > 0 then
                    chr:TranslateBy(hum.MoveDirection)
                end
            end
        end)
    end
    
    -- Отключаем состояния человечка
    for _, state in pairs(Enum.HumanoidStateType:GetEnumItems()) do
        humanoid:SetStateEnabled(state, false)
    end
    humanoid:ChangeState(Enum.HumanoidStateType.Swimming)
    
    -- Создаем физику полета
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    if not rootPart then return end
    
    local bg = Instance.new("BodyGyro")
    bg.P = 9e4
    bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.cframe = rootPart.CFrame
    bg.Parent = rootPart
    
    local bv = Instance.new("BodyVelocity")
    bv.velocity = Vector3.new(0, 0.1, 0)
    bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
    bv.Parent = rootPart
    
    humanoid.PlatformStand = true
    
    -- Управление полетом
    local ctrl = {f = 0, b = 0, l = 0, r = 0}
    local lastCtrl = {f = 0, b = 0, l = 0, r = 0}
    local maxSpeed = 50
    local currentSpeed = 0
    
    local flightConnection
    flightConnection = RunService.Heartbeat:Connect(function()
        if not isFlying or not character or humanoid.Health <= 0 then
            flightConnection:Disconnect()
            return
        end
        
        -- Обновление скорости
        if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
            currentSpeed = math.min(currentSpeed + 0.5 + (currentSpeed / maxSpeed), maxSpeed)
        elseif currentSpeed > 0 then
            currentSpeed = math.max(currentSpeed - 1, 0)
        end
        
        -- Расчет движения
        if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
            local cam = workspace.CurrentCamera
            bv.velocity = ((cam.CFrame.lookVector * (ctrl.f + ctrl.b)) + 
                          ((cam.CFrame * CFrame.new(ctrl.l + ctrl.r, (ctrl.f + ctrl.b) * 0.2, 0).p) - cam.CFrame.p)) * currentSpeed
            lastCtrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
        elseif currentSpeed > 0 then
            local cam = workspace.CurrentCamera
            bv.velocity = ((cam.CFrame.lookVector * (lastCtrl.f + lastCtrl.b)) + 
                          ((cam.CFrame * CFrame.new(lastCtrl.l + lastCtrl.r, (lastCtrl.f + lastCtrl.b) * 0.2, 0).p) - cam.CFrame.p)) * currentSpeed
        else
            bv.velocity = Vector3.new(0, 0, 0)
        end
        
        -- Поворот
        bg.cframe = workspace.CurrentCamera.CFrame * CFrame.Angles(-math.rad((ctrl.f + ctrl.b) * 50 * currentSpeed / maxSpeed), 0, 0)
    end)
    
    -- Обработка ввода
    local inputConnection
    inputConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.W then
            ctrl.f = 1
        elseif input.KeyCode == Enum.KeyCode.S then
            ctrl.b = -1
        elseif input.KeyCode == Enum.KeyCode.A then
            ctrl.l = -1
        elseif input.KeyCode == Enum.KeyCode.D then
            ctrl.r = 1
        end
    end)
    
    local inputEndedConnection
    inputEndedConnection = UserInputService.InputEnded:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.W then
            ctrl.f = 0
        elseif input.KeyCode == Enum.KeyCode.S then
            ctrl.b = 0
        elseif input.KeyCode == Enum.KeyCode.A then
            ctrl.l = 0
        elseif input.KeyCode == Enum.KeyCode.D then
            ctrl.r = 0
        end
    end)
    
    -- Сохраняем соединения для очистки
    character:SetAttribute("FlightConnections", {flightConnection, inputConnection, inputEndedConnection})
    character:SetAttribute("FlightParts", {bg, bv})
end

local function disableFlight()
    if not isFlying then return end
    
    isFlying = false
    tpwalking = false
    onof.Text = "FLY"
    onof.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
    
    local character = player.Character
    if not character then return end
    
    -- Восстанавливаем анимации
    character.Animate.Disabled = false
    
    -- Восстанавливаем состояния человечка
    local humanoid = character:FindFirstChildWhichIsA("Humanoid")
    if humanoid then
        for _, state in pairs(Enum.HumanoidStateType:GetEnumItems()) do
            humanoid:SetStateEnabled(state, true)
        end
        humanoid.PlatformStand = false
        humanoid:ChangeState(Enum.HumanoidStateType.Running)
    end
    
    -- Удаляем физику полета
    local connections = character:GetAttribute("FlightConnections")
    if connections then
        for _, conn in ipairs(connections) do
            if conn then
                conn:Disconnect()
            end
        end
    end
    
    local parts = character:GetAttribute("FlightParts")
    if parts then
        for _, part in ipairs(parts) do
            if part then
                part:Destroy()
            end
        end
    end
end

-- Обработчики кнопок
onof.MouseButton1Click:Connect(function()
    if isFlying then
        disableFlight()
    else
        enableFlight()
    end
end)

local function createVerticalMovement(button, direction)
    local connection
    button.MouseButton1Down:Connect(function()
        connection = button.MouseEnter:Connect(function()
            while connection do
                RunService.Heartbeat:Wait()
                local character = player.Character
                if character then
                    local root = character:FindFirstChild("HumanoidRootPart")
                    if root then
                        root.CFrame = root.CFrame * CFrame.new(0, direction, 0)
                    end
                end
            end
        end)
    end)
    
    button.MouseLeave:Connect(function()
        if connection then
            connection:Disconnect()
            connection = nil
        end
    end)
    
    button.MouseButton1Up:Connect(function()
        if connection then
            connection:Disconnect()
            connection = nil
        end
    end)
end

createVerticalMovement(up, 1)    -- Вверх
createVerticalMovement(down, -1) -- Вниз

plus.MouseButton1Click:Connect(function()
    speeds = math.min(speeds + 1, 10)
    speed.Text = tostring(speeds)
    
    if isFlying then
        disableFlight()
        enableFlight()
    end
end)

mine.MouseButton1Click:Connect(function()
    if speeds > 1 then
        speeds = math.max(speeds - 1, 1)
        speed.Text = tostring(speeds)
        
        if isFlying then
            disableFlight()
            enableFlight()
        end
    else
        local originalText = speed.Text
        speed.Text = "MIN: 1"
        wait(1)
        speed.Text = originalText
    end
end)

closebutton.MouseButton1Click:Connect(function()
    disableFlight()
    main:Destroy()
end)

mini.MouseButton1Click:Connect(function()
    isGUIVisible = false
    up.Visible = false
    down.Visible = false
    onof.Visible = false
    plus.Visible = false
    speed.Visible = false
    mine.Visible = false
    mini.Visible = false
    mini2.Visible = true
    Frame.BackgroundTransparency = 1
    closebutton.Position = UDim2.new(0, 0, -1, 57)
end)

mini2.MouseButton1Click:Connect(function()
    isGUIVisible = true
    up.Visible = true
    down.Visible = true
    onof.Visible = true
    plus.Visible = true
    speed.Visible = true
    mine.Visible = true
    mini.Visible = true
    mini2.Visible = false
    Frame.BackgroundTransparency = 0
    closebutton.Position = UDim2.new(0, 0, -1, 27)
end)

-- Управление видимостью GUI по клавише Insert
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.Insert then
        if isGUIVisible then
            -- Плавное скрытие
            local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = TweenService:Create(Frame, tweenInfo, {Position = UDim2.new(-0.3, 0, Frame.Position.Y.Scale, 0)})
            tween:Play()
            wait(0.3)
            Frame.Visible = false
        else
            -- Плавное появление
            Frame.Visible = true
            local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = TweenService:Create(Frame, tweenInfo, {Position = UDim2.new(0.1, 0, 0.38, 0)})
            tween:Play()
        end
        isGUIVisible = not isGUIVisible
    elseif input.KeyCode == Enum.KeyCode.Delete then
        -- Быстрое отключение полета при нажатии Delete
        if isFlying then
            disableFlight()
        end
    end
end)

-- Автоматическое отключение полета при смерти
player.CharacterAdded:Connect(function(character)
    wait(1) -- Ждем загрузки персонажа
    disableFlight()
    
    -- Автоматическое подключение Humanoid для отслеживания смерти
    character:WaitForChild("Humanoid").Died:Connect(function()
        disableFlight()
    end)
end)

-- Информация об управлении
print("Fly GUI V3 loaded!")
print("Controls:")
print("Insert - Show/Hide GUI")
print("Delete - Quick disable flight")
print("WASD - Flight movement")
print("UP/DOWN buttons - Vertical movement")