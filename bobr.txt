-- AIMBOT SYSTEM
local aimbotConnection
local aimKey = Enum.UserInputType.MouseButton2

local function getClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge
    local localRoot = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    
    if not localRoot then return nil end
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            -- Проверяем, не тиммейт ли игрок
            local isTeammate = false
            
            -- Проверка через Team
            if player.Team and otherPlayer.Team then
                if player.Team == otherPlayer.Team then
                    isTeammate = true
                end
            end
            
            -- Проверка через TeamColor (для старых игр)
            if player.TeamColor and otherPlayer.TeamColor then
                if player.TeamColor == otherPlayer.TeamColor then
                    isTeammate = true
                end
            end
            
            -- Если это тиммейт - пропускаем
            if isTeammate then
                continue
            end
            
            local targetRoot = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = otherPlayer.Character:FindFirstChildWhichIsA("Humanoid")
            
            if targetRoot and humanoid and humanoid.Health > 0 then
                local distance = (localRoot.Position - targetRoot.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = otherPlayer
                end
            end
        end
    end
    
    return closestPlayer
end

local function aimAtPlayer(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then return end
    
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    local camera = workspace.CurrentCamera
    
    if targetRoot and camera then
        camera.CFrame = CFrame.new(camera.CFrame.Position, targetRoot.Position)
    end
end

local function enableAimbot()
    if isAimbotEnabled then return end
    
    isAimbotEnabled = true
    AimbotToggle.Text = "Disable Aimbot"
    AimbotToggle.BackgroundColor3 = Color3.fromRGB(214, 86, 86)
    
    aimbotConnection = RunService.Heartbeat:Connect(function()
        if not isAimbotEnabled then return end
        
        if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
            local closestPlayer = getClosestPlayer()
            if closestPlayer then
                aimAtPlayer(closestPlayer)
            end
        end
    end)
end

local function disableAimbot()
    if not isAimbotEnabled then return end
    
    isAimbotEnabled = false
    AimbotToggle.Text = "Enable Aimbot"
    AimbotToggle.BackgroundColor3 = tabs.Aimbot.color
    
    if aimbotConnection then
        aimbotConnection:Disconnect()
    end
end
